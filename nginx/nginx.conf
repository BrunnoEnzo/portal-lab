# nginx/nginx.conf (Versão Final e Corrigida)

server {
    listen 80;
    server_name localhost;

    # =================================================================
    # REGRAS ESPECÍFICAS PARA A API DO BACKEND
    # Estas regras têm prioridade máxima para garantir que os endpoints
    # de login, registro e social-login cheguem ao backend.
    # =================================================================

    location = /api/auth/login {
        proxy_pass http://backend:3001/auth/login;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /api/auth/register {
        proxy_pass http://backend:3001/auth/register;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location = /api/auth/social-login {
        proxy_pass http://backend:3001/auth/social-login;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # =================================================================
    # REGRAS GERAIS
    # =================================================================

    # 1. Regra para as rotas internas do NextAuth (Frontend)
    # Captura o resto das chamadas do NextAuth (/api/auth/session, /api/auth/providers, etc.)
    location /api/auth/ {
        proxy_pass http://frontend:3000/api/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Regra para o resto da sua API do Backend
    location /api/ {
        proxy_pass http://backend:3001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. Regra para todo o tráfego do site (Frontend)
    location / {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}